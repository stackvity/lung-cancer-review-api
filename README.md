# AI Lung Cancer Review System - Backend API

## Overview

This backend provides a secure and scalable API service for the Patient-Centric AI Lung Cancer Diagnosis and Treatment Recommendation System. It allows patients to upload medical documents (DICOM images, pathology reports, radiology reports, lab results) and receive a _preliminary_ AI-powered review. The system leverages the Google AI Gemini 2.0 APIs for image and text analysis to generate findings, _preliminary_ diagnoses, staging information, and _potential_ treatment options.

**Important Disclaimer:** This system provides _preliminary_ information for informational purposes only and **is NOT a substitute for professional medical advice, diagnosis, or treatment.** All findings and recommendations generated by this system **MUST be reviewed and confirmed by a qualified healthcare professional.** Patients should **never** make health-related decisions based solely on the output of this API.

## Features

This backend API implements the following key features, developed across multiple sprints:

**Sprint 1: Secure Access and Basic Infrastructure**

- **Secure Access Links:** Implements a mechanism for patients to access the system using unique, time-limited, and expiring access links, ensuring secure and controlled access without traditional user accounts.
- **Disclaimer and Terms of Use:** Requires patients to acknowledge a disclaimer and terms of use before accessing the application, emphasizing the system's limitations and the need for physician consultation.
- **Basic API Endpoints:** Sets up foundational API endpoints for file uploads, status checks, and report retrieval, providing a basic framework for the API service.
- **Deployment to Render.com:** Configures and automates deployment to Render.com, establishing the cloud infrastructure for the backend service.
- **Unit and Integration Tests:** Includes unit and integration tests for core functionalities like link generation and basic API endpoints, ensuring code quality and reliability from the outset.

**Sprint 2: Document Upload and Preprocessing**

- **Document Upload Functionality:** Enables patients to upload medical documents (DICOM, PDF, JPEG, PNG, CSV) through a dedicated API endpoint, supporting various medical data formats.
- **File Validation:** Implements robust file type and size validation to ensure only supported and appropriately sized files are processed, enhancing data integrity and system security.
- **Virus Scanning:** Integrates virus scanning for all uploaded files to protect the system and patient data from potential malware threats.
- **Temporary File Storage:** Utilizes secure, temporary file storage for uploaded documents during processing, ensuring data privacy and efficient resource management.
- **OCR Integration (Basic):** Integrates Optical Character Recognition (OCR) for text extraction from PDF and image-based reports, enabling AI analysis of textual medical data.
- **Structured Data Input Handling (Skeleton):** Sets up the basic backend structure for handling structured data input from patients, preparing for future feature enhancements.
- **Error Handling and Reporting (Basic):** Implements basic error handling and reporting mechanisms for file upload and processing stages, ensuring system stability and providing informative feedback.

**Sprint 3: AI Integration - Nodule Detection & Basic Reporting**

- **Google AI Gemini 2.0 API Integration (Initial):** Integrates with the Google AI Gemini 2.0 API for AI-powered analysis, starting with nodule detection in medical images.
- **Nodule Detection API Endpoint:** Implements an API endpoint to leverage Gemini 2.0 for detecting potential lung nodules in uploaded DICOM images.
- **Basic Report Generation:** Develops backend functionality for generating basic reports summarizing AI findings, focusing initially on nodule detection results.
- **Nodule Data Model and Database Integration:** Creates a data model and database schema to store and manage nodule information extracted by the AI, ensuring structured data management.
- **Unit and Integration Tests for AI Integration:** Includes unit and integration tests specifically for the Gemini 2.0 API client and nodule detection logic, validating the AI integration and data flow.
- **Error Handling and Logging for AI API Calls:** Implements error handling and logging for Gemini 2.0 API interactions, ensuring robust and traceable AI service integration.

**Sprint 4: AI-Powered Assessment - Preliminary Diagnosis, Staging, and Treatment Options**

- **Preliminary Diagnosis Generation (Gemini 2.0):** Integrates Gemini 2.0 to generate _preliminary_ lung cancer diagnoses based on uploaded medical data, providing initial diagnostic insights.
- **Staging Information Retrieval (Gemini 2.0):** Leverages Gemini 2.0 to determine _preliminary_ TNM staging information, offering a preliminary assessment of disease progression.
- **Treatment Options Suggestion (Gemini 2.0):** Utilizes Gemini 2.0 to suggest _potential_ treatment options based on the _preliminary_ diagnosis and staging, providing patients with potential next steps for discussion with their physicians.
- **Enhanced Report Generation (AI-Powered Content):** Updates report generation to include _preliminary_ diagnoses, staging information, and _potential_ treatment options, providing a more comprehensive patient summary.
- **Data Models for Diagnosis, Staging, and Treatment Recommendations:** Creates data models and database schema to store and manage AI-generated diagnoses, staging, and treatment recommendations.
- **Feature Flag for Diagnostic Capabilities:** Implements a mechanism to disable diagnostic and recommendation features, allowing for system control and safety measures if needed.
- **Unit and Integration Tests for Diagnostic Features:** Includes unit and integration tests for the new diagnostic, staging, and treatment recommendation functionalities, ensuring the reliability and accuracy of AI-driven insights.
- **Basic Rule-Based System/Knowledge Base Integration (Placeholder):** Sets up a placeholder for future integration of a rule-based system or knowledge base, preparing for enhanced clinical guideline incorporation in later sprints.

**Sprint 5: Report and UI Refinements, Feedback, and Image Annotations**

- **Report Preview Functionality (Backend):** Implements backend logic to support report preview, allowing patients to review reports before downloading.
- **User Feedback Submission and Storage (Backend):** Develops backend functionality for collecting and storing user feedback, enabling continuous system improvement based on user input.
- **Code Refactoring for Report Generation:** Refactors report generation code to improve clarity, maintainability, and scalability, ensuring long-term code quality.
- **Unit and Integration Tests for Refined Features:** Includes unit and integration tests for report preview, feedback submission, and code refactoring, validating the enhancements and maintaining code integrity.
- **Data Validation and Sanitization Enhancements:** Improves data validation and sanitization across the backend to enhance data quality and system security.
- **Security Scans (SAST/DAST) Implementation:** Integrates Static Application Security Testing (SAST) and Dynamic Application Security Testing (DAST) to proactively identify and address potential security vulnerabilities.

**Sprint 6: Knowledge Base and System Admin (Part 1)**

- **Knowledge Base Schema Design:** Designs the database schema for storing medical terminologies and knowledge base content, laying the foundation for a robust clinical knowledge repository.
- **Basic Knowledge Base API (Internal):** Implements a basic internal API for accessing the knowledge base, providing a programmatic interface for system components to retrieve clinical knowledge.
- **Guidelines Data Loading Mechanism:** Develops a mechanism to load clinical guidelines data into the knowledge base, starting with structured guidelines data integration.
- **Admin Login with MFA:** Implements secure admin login functionality with Multi-Factor Authentication (MFA), enhancing system security for administrative access.
- **System Monitoring Dashboard (Backend):** Creates the backend infrastructure for a system monitoring dashboard, enabling administrators to track system health and performance.
- **Audit Log Viewing (Backend):** Develops the backend component for viewing and searching audit logs, providing tools for security monitoring and compliance.

**Sprint 7: System Admin (Part 2) and Messaging**

- **Content Management Functionality (Backend):** Implements backend features for content management, allowing administrators to update system content with a review and approval workflow.
- **Prompt Management Functionality (Backend):** Develops backend prompt management capabilities, enabling administrators to manage and version prompts for AI interactions, also with a review and approval workflow.
- **Database Backup Functionality (Manual):** Implements manual database backup functionality for data protection and disaster recovery.
- **Database Restore Functionality:** Develops database restore functionality, allowing administrators to recover data from backups.
- **Access Link Generation (Backend):** Implements the backend logic for generating access links, providing a secure mechanism for patient access.
- **Access Link Delivery (Verified Email):** Sets up access link delivery via verified email, ensuring secure and reliable link distribution to patients.
- **Basic Non-Clinical Message Sending:** Implements basic messaging for non-clinical notifications to patients, such as upload confirmations, enhancing user communication.

**Sprint 8: Bug Fixes, Refinements, and Preparation for Clinical Validation**

- **Bug Fixing:** Addresses and resolves identified bugs from previous sprints, improving system stability and reliability.
- **Code Refactoring:** Refactors code based on code reviews and testing feedback to enhance code quality and maintainability.
- **Documentation Finalization:** Completes and finalizes system documentation, API documentation, and user documentation, ensuring comprehensive project documentation.
- **Clinical Validation Preparation:** Prepares the system for clinical validation studies, focusing on data anonymization, data export features, and ensuring the system is ready for rigorous clinical evaluation.
- **Security Hardening:** Implements final security hardening measures to protect the system against potential vulnerabilities.
- **Performance and Load Testing (Final):** Conducts final performance and load testing to ensure the system can handle expected user loads and maintain performance under stress.
- **Automated Data Deletion:** Implements automated data deletion based on defined retention policies, ensuring compliance with data privacy regulations.
- **Automatic Link Expiration:** Implements automatic expiration and invalidation of access links after a defined period, enhancing access security.
- **Fallback Mechanism for Gemini 2.0 API Failures:** Verifies and ensures the implementation of a fallback mechanism to handle Gemini 2.0 API call failures gracefully, maintaining system resilience.

## Technical Stack

- **Backend:**
  - **Language/Framework:** Go 1.21 / Gin
  - **Database:** PostgreSQL 16
  - **Caching:** ristretto
  - **AI/ML API:** Google AI Gemini 2.0 API
  - **OCR:** Google Cloud Vision API (or Tesseract OCR)
  - **Deployment:** Render.com

_For a comprehensive list of technologies and libraries, please refer to [backend-techstack.md](backend-techstack.md)._

## Folder Structure

The backend codebase is organized following a clean architecture, with clear separation of concerns. Key directories include:

```
/backend
├── /cmd             # Application entry points
├── /internal       # Core application logic
│   ├── /api        # API-specific logic (handlers, routes)
│   ├── /config     # Configuration management
│   ├── /data       # Data access layer (repositories, models, queries)
│   ├── /domain     # Business logic (entities, services)
│   ├── /gemini     # Gemini API client and related logic
│   ├── /knowledge  # Knowledge base integration (future sprints)
│   ├── /ocr        # OCR service integration
│   ├── /pdf        # PDF report generation
│   ├── /security   # Security-related functionalities
│   ├── /storage    # File storage abstraction
│   └── /utils      # Utility functions
├── /mocks          # Mock implementations for testing
├── /migrations     # Database migrations
├── /scripts        # Deployment and utility scripts
├── Dockerfile      # Dockerfile for containerization
├── docker-compose.yml # Docker Compose for local development
├── go.mod          # Go module definition
├── go.sum          # Go module checksums
├── .env.example    # Example environment variables
├── .golangci.yml   # golangci-lint configuration
├── Makefile        # Makefile for common tasks
├── README.md       # This file
└── sqlc.yaml       # sqlc configuration file
```

_For a detailed breakdown, please refer to [backend-folder-structure.md](backend-folder-structure.md)._

## Getting Started

To run the backend API locally, follow these steps:

### Prerequisites

- Go 1.21 or higher installed
- Docker and Docker Compose (optional, for local development with Docker)
- PostgreSQL database (local or cloud-based)
- A Google Cloud Project with the Gemini API enabled and an API key

### Configuration

1.  **Clone the repository:**
    ```bash
    git clone https://github.com/[your-org]/lung-cancer-review-api.git
    cd lung-cancer-review-api/backend
    ```
2.  **Create a `.env` file:** Copy `.env.example` to `.env` and fill in the required environment variables. **Ensure to configure your PostgreSQL database credentials, Google Gemini API key, and a secure `FILE_ENCRYPTION_KEY`.**
    ```bash
    cp .env.example .env
    # Edit .env and configure variables
    ```
3.  **Install dependencies:**
    ```bash
    go mod download
    go mod verify
    ```

### Running the Application

**Without Docker:**

1.  **Start PostgreSQL:** Ensure your PostgreSQL database is running and accessible.
2.  **Run database migrations:**
    ```bash
    make migrate-up
    ```
3.  **Build and run the backend API:**
    ```bash
    make run
    ```

**With Docker (Optional - for local development):**

1.  **Ensure Docker is installed and running.**
2.  **Start the application and database using Docker Compose:**
    ```bash
    docker-compose up --build
    ```
    This command builds the Docker image, starts the PostgreSQL database in a container, and runs the backend API service.

### Accessing the API

The API will be accessible at the address configured in your `.env` file (default is `http://localhost:8080`).

- **Health Check Endpoint:** `http://localhost:8080/api/v1/health`

_For API endpoint documentation, refer to the OpenAPI/Swagger specification in [api/openapi.yaml](api/openapi.yaml) (and accessible via `/api/v1/docs` when the application is running)._

## Deployment

The backend API is designed to be deployed on [Render.com](https://render.com) using Docker.

_For detailed deployment instructions and CI/CD setup, please refer to [cloud-deploy.md](cloud-deploy.md) and the `Dockerfile`, `render.yaml`, and `.github/workflows/deploy.yml` files._

## Security Notes

**Security is paramount for this project.** Please ensure to:

- **Securely manage your Google Gemini API key and File Encryption Key.** _Never hardcode API keys or encryption keys directly in the code._ Use environment variables (for local development _only_) and a dedicated secrets management service (e.g., HashiCorp Vault, AWS Secrets Manager, Google Cloud Secret Manager) for production.
- **Use HTTPS for all API communication.** Render.com automatically provides HTTPS.
- **Regularly update dependencies** to patch known vulnerabilities.
- **Conduct thorough security testing and code reviews.**
- **Consult with security experts** to ensure best practices are followed.

**Remember to review and configure security settings according to your specific needs and security policies.**

## Disclaimer

**This system is for informational purposes only and DOES NOT provide medical advice.** Always consult with a qualified healthcare professional for diagnosis and treatment decisions.
